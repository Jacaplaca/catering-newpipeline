name: Deploy to Stage

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Environment stage (ignored if Custom Stage Name is set)'
        required: true
        type: choice
        options:
          - test
          - demo
          - prod
        default: 'test'
      custom_stage_name:
        description: 'Custom Stage Name (overrides selection above, e.g. client_x)'
        required: false
        type: string
      should_rebuild:
        description: 'Should rebuild Docker images?'
        required: true
        type: choice
        options:
          - "yes"
          - "no"
        default: "yes"
      should_git_pull:
        description: 'Should pull from Git?'
        required: true
        type: choice
        options:
          - "yes"
          - "no"
        default: "yes"
      should_docker_version:
        description: 'Should create versioned Docker image?'
        required: true
        type: choice
        options:
          - "yes"
          - "no"
        default: "yes"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Base configuration
      # Use custom_stage_name if provided, otherwise use the selected stage option
      STAGE: ${{ github.event.inputs.custom_stage_name != '' && github.event.inputs.custom_stage_name || github.event.inputs.stage }}
      SHOULD_REBUILD: ${{ github.event.inputs.should_rebuild }}
      SHOULD_GIT_PULL: ${{ github.event.inputs.should_git_pull }}
      SHOULD_DOCKER_VERSION: ${{ github.event.inputs.should_docker_version }}
      REPO_BASE_NAME: ${{ github.event.repository.name }}
      # Connection variables - change source here to propagate everywhere
      SSH_USER: ${{ vars.USER || secrets.USER }}
      SSH_HOST: ${{ vars.HOST || secrets.HOST }}
      # APP_ROOT is the base directory containing all stages and config files (.env.prod, .env.test)
      APP_ROOT: /home/${{ vars.USER || secrets.USER }}/my_project/apps/${{ github.event.repository.name }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Environment Variables
      run: |
        echo "Setting up environment variables for stage: $STAGE"

        # Define target deployment directory: e.g., .../repo_name/test
        echo "DEPLOY_DIR=$APP_ROOT/$STAGE" >> $GITHUB_ENV

        # Define Docker Compose project name to allow side-by-side deployments
        # e.g., repo_name_test, repo_name_prod
        echo "PROJECT_NAME=${REPO_BASE_NAME}_${STAGE}" >> $GITHUB_ENV

        # Define named volume for cache to avoid conflicts
        echo "CACHE_VOLUME_NAME=data_${REPO_BASE_NAME}_${STAGE}" >> $GITHUB_ENV

    - name: Setup SSH Keys
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        # SSH_HOST and SSH_USER are inherited from job env
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan "$SSH_HOST" >> ~/.ssh/known_hosts

    - name: Make local scripts executable
      run: chmod -R +x .github/scripts/

    - name: Pull latest changes via SSH
      env:
        # Construct the URL using the alias format expected by the server's SSH config
        REPO_URL: git@github.com-${{ github.event.repository.name }}:${{ github.repository }}.git
      run: |
        ssh -i ~/.ssh/deploy_key "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" \
          "REPO_URL='${{ env.REPO_URL }}' \
           APP_ROOT='${{ env.APP_ROOT }}' \
           DEPLOY_DIR='${{ env.DEPLOY_DIR }}' \
           STAGE='${{ env.STAGE }}' \
           SHOULD_GIT_PULL='${{ env.SHOULD_GIT_PULL }}' \
           bash -c '
             set -e
             set -x
             
             echo \"Deploying to stage: \$STAGE\"
             echo \"Target directory: \$DEPLOY_DIR\"
             echo \"Repository URL: \$REPO_URL\"
             
             # Pre-flight check: Verify configuration file exists
             ENV_SOURCE=\"\$APP_ROOT/.env.\$STAGE\"
             if [ ! -f \"\$ENV_SOURCE\" ]; then
               echo \"❌ Critical Error: Configuration file \$ENV_SOURCE does not exist on the server.\"
               echo \"Please create .env.\$STAGE in \$APP_ROOT before deploying.\"
               exit 1
             fi

             # Ensure deployment directory exists
             mkdir -p \"\$DEPLOY_DIR\"
             cd \"\$DEPLOY_DIR\"

             # Clone or Pull
             if [ \"\$SHOULD_GIT_PULL\" = \"no\" ]; then
                echo \"Skipping git pull/clone as requested.\"
                if [ ! -d \".git\" ]; then
                   echo \"❌ Critical Error: Git repository not found in \$DEPLOY_DIR but git pull was disabled.\"
                   exit 1
                fi
             else
                 if [ ! -d \".git\" ]; then
                   echo \"Directory exists but is not a git repository. Cleaning up...\"
                   # Remove everything in the directory to allow fresh clone
                   if [ \"\$(ls -A)\" ]; then
                     rm -rf ./* .[^.]*
                   fi
                   
                   echo \"Cloning repository...\"
                   git clone \"\$REPO_URL\" .
                 else
                   echo \"Pulling latest changes...\"
                   git remote set-url origin \"\$REPO_URL\"
                   git fetch origin
                   git reset --hard origin/main
                 fi
             fi

             echo \"Setting up .env from \$ENV_SOURCE\"
             cp \"\$ENV_SOURCE\" .env
             echo \"✅ Copied \$ENV_SOURCE to .env\"
             
             # Ensure scripts are executable on remote
             if [ -d \".github/scripts\" ]; then
                chmod -R +x .github/scripts/
             fi
           '"

    - name: Deploy (remote driver)
      run: |
        ssh -i ~/.ssh/deploy_key "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" \
          "REPO_NAME='${{ env.PROJECT_NAME }}' \
           SHOULD_REBUILD='${{ env.SHOULD_REBUILD }}' \
           SHOULD_DOCKER_VERSION='${{ env.SHOULD_DOCKER_VERSION }}' \
           APP_DIR='${{ env.APP_ROOT }}' \
           DEPLOY_DIR='${{ env.DEPLOY_DIR }}' \
           CACHE_VOLUME_NAME='${{ env.CACHE_VOLUME_NAME }}' \
           bash '${{ env.DEPLOY_DIR }}/.github/scripts/deploy_remote.sh'"

    - name: Display Container Startup Logs (Entrypoint)
      if: always()
      run: |
        echo "Fetching logs for container project ${{ env.PROJECT_NAME }}..."
        ssh -i ~/.ssh/deploy_key "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" \
          "docker compose --env-file ${{ env.DEPLOY_DIR }}/.env -f ${{ env.DEPLOY_DIR }}/deployment/docker-compose.yml -p ${{ env.PROJECT_NAME }} --profile backup logs --tail=100"
