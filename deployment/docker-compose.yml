services:
  app:
    container_name: "${APP_NAME}"
    image: "${APP_NAME}_img"
    build:
      context: ../
      dockerfile: deployment/Dockerfile
    restart: always
    ports:
      - "${PORT}:${PORT}"
    env_file:
      - ../.env
    environment:
      TZ: ${TZ}
      PORT: ${PORT}
      HOST: 0.0.0.0
      HOSTNAME: 0.0.0.0
    networks:
      - default

    # Security
    read_only: true
    tmpfs:
      - /tmp
      - /app/.npm

    volumes:
      - next_cache:/app/.next/cache
      - ../logs:/app/logs

  dbtools:
    container_name: "${APP_NAME}_dbtools"
    image: "${APP_NAME}_dbtools_img"
    build:
      context: ../
      dockerfile: deployment/Dockerfile
      target: dbtools
    restart: "no"
    env_file:
      - ../.env
    environment:
      TZ: ${TZ}
      HOST: 0.0.0.0
      HOSTNAME: 0.0.0.0
    networks:
      - default
    profiles:
      - tools
    volumes:
      - ../scripts:/app/scripts
      - ../prisma:/app/prisma

  backup:
    container_name: "${APP_NAME}_backup"
    image: "${APP_NAME}_backup_img"
    build:
      context: ./backup-service
      dockerfile: Dockerfile
    restart: always
    profiles:
      - backup
    depends_on:
      app:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      TZ: ${TZ}

      # Database
      DATABASE_URL: ${DATABASE_URL}

      # S3
      AWS_REGION: ${S3_REGION}
      AWS_ACCESS_KEY_ID: ${S3_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${S3_KEY_SECRET}
      AWS_S3_BUCKET: ${S3_BUCKET}
      AWS_ENDPOINT: ${S3_SERVER_ENDPOINT}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-false}

      # Backup config
      BACKUP_CRON: ${BACKUP_CRON:-0 4 * * *}
      BACKUP_DRY_RUN: ${BACKUP_DRY_RUN:-false}
      BACKUP_DIR: /backups
      MAX_REMOTE_BACKUPS: ${BACKUP_KEEP:-7}
      APP_NAME: ${APP_NAME}

    volumes:
      - ../backups:/backups

networks:
  default:
    name: "${DOCKER_NETWORK_NAME}"
    external: true

volumes:
  next_cache:
    name: "${CACHE_VOLUME_NAME}"
